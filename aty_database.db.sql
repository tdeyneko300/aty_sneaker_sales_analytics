BEGIN TRANSACTION;
DROP TABLE IF EXISTS "batches";
CREATE TABLE batches (
    id INTEGER PRIMARY KEY,
    batch_name VARCHAR(50) UNIQUE NOT NULL,
    purchase_date DATE NOT NULL
);
DROP TABLE IF EXISTS "clients";
CREATE TABLE clients (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) UNIQUE,
    gender VARCHAR(1) CHECK (gender IN ('M', 'F')),
    channel VARCHAR(20) CHECK (channel IN ('Авито', 'Telegram')),
    created_at DATE
);
DROP TABLE IF EXISTS "order_items";
CREATE TABLE order_items (
    id INTEGER PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE RESTRICT,
    quantity INTEGER DEFAULT 1 CHECK (quantity > 0),
    price_at_sale DECIMAL(8,2) NOT NULL
);
DROP TABLE IF EXISTS "orders";
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    client_id INTEGER NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
    order_date DATE NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'completed'
);
DROP TABLE IF EXISTS "products";
CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    brand VARCHAR(50) NOT NULL,
    model VARCHAR(100) NOT NULL,
    size VARCHAR(10),
    cost DECIMAL(8,2),
    sale_price DECIMAL(8,2) NOT NULL,
    batch_id INTEGER REFERENCES batches(id)
);
INSERT INTO "batches" ("id","batch_name","purchase_date") VALUES (1,'B1','2025-01-10'),
 (2,'B2','2025-02-05'),
 (3,'B3','2025-03-15'),
 (4,'B4','2025-04-20');
INSERT INTO "clients" ("id","name","phone","gender","channel","created_at") VALUES (1,'СергейК','79100000001','M','Авито','2025-01-05'),
 (2,'АлексейМ','79100000002','M','Telegram','2025-01-06'),
 (3,'ИванС','79100000003','M','Авито','2025-01-07'),
 (4,'ДмитрийГ','79100000004','M','Telegram','2025-01-12'),
 (5,'МаксимБ','79100000005','M','Авито','2025-01-14'),
 (6,'РоманЗ','79100000006','M','Telegram','2025-01-22'),
 (7,'АртёмЦ','79100000007','M','Авито','2025-01-24'),
 (8,'ЕгорШ','79100000008','M','Telegram','2025-01-26'),
 (9,'ТимурЮ','79100000009','M','Авито','2025-01-28'),
 (10,'КириллЛ','79100000010','M','Telegram','2025-02-01'),
 (11,'ВладимирД','79100000011','M','Авито','2025-01-18'),
 (12,'ПавелФ','79100000012','M','Telegram','2025-01-20'),
 (13,'НиколайР','79100000013','M','Авито','2025-01-16'),
 (14,'ЛеонидН','79100000014','M','Telegram','2025-02-03'),
 (15,'БогданИ','79100000015','M','Авито','2025-02-01'),
 (16,'shopper1','79100000016','M','Telegram','2025-01-10'),
 (17,'shopper3','79100000017','M','Авито','2025-02-05'),
 (18,'shopper5','79100000018','M','Telegram','2025-02-07'),
 (19,'АннаШ','79200000001','F','Telegram','2025-01-08'),
 (20,'МарияП','79200000002','F','Авито','2025-01-09'),
 (21,'ЕленаВ','79200000003','F','Telegram','2025-01-13'),
 (22,'ОльгаК','79200000004','F','Авито','2025-01-15'),
 (23,'ТатьянаЛ','79200000005','F','Telegram','2025-01-17'),
 (24,'ИринаН','79200000006','F','Авито','2025-01-19'),
 (25,'КсенияТ','79200000007','F','Telegram','2025-01-21'),
 (26,'ЮлияХ','79200000008','F','Авито','2025-01-23'),
 (27,'СветланаЫ','79200000009','F','Telegram','2025-01-25'),
 (28,'ВероникаЭ','79200000010','F','Авито','2025-01-27'),
 (29,'АлинаЖ','79200000011','F','Telegram','2025-01-29'),
 (30,'ДарьяК','79200000012','F','Авито','2025-02-02');
INSERT INTO "order_items" ("id","order_id","product_id","quantity","price_at_sale") VALUES (1,1,1,1,12000),
 (2,1,8,1,12500),
 (3,2,3,1,25500),
 (4,3,4,1,10500),
 (5,3,5,1,14000),
 (6,4,10,1,9100),
 (7,5,6,1,21500),
 (8,6,11,1,10500),
 (9,7,13,1,9000),
 (10,8,17,1,15500),
 (11,9,21,1,7800),
 (12,10,20,1,20500),
 (13,11,12,1,9500),
 (14,12,15,1,13000),
 (15,13,14,1,19500),
 (16,14,18,1,11000),
 (17,15,24,1,21800),
 (18,16,22,1,7200),
 (19,17,23,1,12800),
 (20,18,25,1,8800),
 (21,19,26,1,10200),
 (22,20,27,1,10800),
 (23,21,28,1,9200),
 (24,22,29,1,7200),
 (25,23,30,1,12800),
 (26,24,31,1,19800),
 (27,25,3,1,25500),
 (28,26,1,1,12000),
 (29,27,2,1,11500),
 (30,28,4,2,10500),
 (31,29,9,1,7500),
 (32,30,16,1,13000),
 (33,31,7,1,12500),
 (34,32,19,1,10000),
 (35,33,21,1,7800),
 (36,34,12,1,9500),
 (37,35,14,1,19500),
 (38,36,27,1,10800),
 (39,37,5,1,14000),
 (40,38,8,1,12500),
 (41,39,20,1,20500),
 (42,40,24,1,21800),
 (43,41,3,1,25500),
 (44,42,11,1,10500),
 (45,43,17,1,15500),
 (46,44,26,1,10200),
 (47,45,28,1,9200),
 (48,46,30,1,12800),
 (49,47,6,1,21500),
 (50,48,15,1,13000),
 (51,49,23,1,12800),
 (52,50,31,1,19800),
 (53,1,3,1,25500),
 (54,10,24,1,21800),
 (55,20,20,1,20500),
 (56,30,17,1,15500),
 (57,40,6,1,21500),
 (58,50,3,1,25500),
 (59,25,14,1,19500),
 (60,15,31,1,19800);
INSERT INTO "orders" ("id","client_id","order_date","total_price","status") VALUES (1,1,'2025-01-15',50000,'completed'),
 (2,2,'2025-01-16',25500,'completed'),
 (3,3,'2025-01-18',24500,'completed'),
 (4,4,'2025-01-20',9100,'completed'),
 (5,5,'2025-01-22',21500,'completed'),
 (6,6,'2025-01-25',10500,'completed'),
 (7,7,'2025-01-27',9000,'completed'),
 (8,8,'2025-01-29',15500,'completed'),
 (9,9,'2025-01-30',7800,'completed'),
 (10,10,'2025-02-02',42300,'completed'),
 (11,11,'2025-02-05',9500,'completed'),
 (12,12,'2025-02-07',13000,'completed'),
 (13,13,'2025-02-10',19500,'completed'),
 (14,14,'2025-02-12',11000,'completed'),
 (15,15,'2025-02-15',41600,'completed'),
 (16,16,'2025-02-18',7200,'completed'),
 (17,17,'2025-02-20',12800,'completed'),
 (18,18,'2025-02-22',8800,'completed'),
 (19,19,'2025-02-25',10200,'completed'),
 (20,20,'2025-02-28',31300,'completed'),
 (21,21,'2025-03-02',9200,'completed'),
 (22,22,'2025-03-05',7200,'completed'),
 (23,23,'2025-03-08',12800,'completed'),
 (24,24,'2025-03-10',19800,'completed'),
 (25,25,'2025-03-12',45000,'completed'),
 (26,1,'2025-03-15',12000,'completed'),
 (27,2,'2025-03-18',11500,'completed'),
 (28,3,'2025-03-20',10500,'completed'),
 (29,4,'2025-03-22',7500,'completed'),
 (30,5,'2025-03-25',28500,'completed'),
 (31,6,'2025-03-28',12500,'completed'),
 (32,7,'2025-04-01',10000,'completed'),
 (33,8,'2025-04-03',7800,'completed'),
 (34,9,'2025-04-05',9500,'completed'),
 (35,10,'2025-04-08',19500,'completed'),
 (36,11,'2025-04-10',10800,'completed'),
 (37,12,'2025-04-12',14000,'completed'),
 (38,13,'2025-04-15',12500,'completed'),
 (39,14,'2025-04-18',20500,'completed'),
 (40,15,'2025-04-20',43300,'completed'),
 (41,16,'2025-04-22',25500,'completed'),
 (42,17,'2025-04-25',10500,'completed'),
 (43,18,'2025-04-28',15500,'completed'),
 (44,19,'2025-05-01',10200,'completed'),
 (45,20,'2025-05-03',9200,'completed'),
 (46,21,'2025-05-05',12800,'completed'),
 (47,22,'2025-05-08',21500,'completed'),
 (48,23,'2025-05-10',13000,'completed'),
 (49,24,'2025-05-12',12800,'completed'),
 (50,25,'2025-05-15',45300,'completed');
INSERT INTO "products" ("id","brand","model","size","cost","sale_price","batch_id") VALUES (1,'Nike','Air Jordan 1 Low','42',9500,12000,1),
 (2,'Nike','Dunk Low','41',7200,11500,1),
 (3,'Adidas','Yeezy 350','42.5',14500,25500,1),
 (4,'Puma','Suede','43',6000,10500,1),
 (5,'New Balance','990v5','44',9500,14000,1),
 (6,'Jordan','Retro 1','41',13000,21500,1),
 (7,'Asics','Gel-1090','42',7800,12500,1),
 (8,'Nike','Air Force 1','43',8000,12500,1),
 (9,'Adidas','Forum Low','41.5',4500,7500,1),
 (10,'Puma','RS-X','42',7100,9100,1),
 (11,'Nike','Blazer Mid','43',5200,10500,2),
 (12,'Adidas','NMD R1','42',6000,9500,2),
 (13,'Puma','Clyde','41',5000,9000,2),
 (14,'New Balance','2002R','44',14400,19500,2),
 (15,'Jordan','1 Mid','42.5',8000,13000,2),
 (16,'Nike','React Element','43',7700,13000,2),
 (17,'Adidas','Ultraboost','41',9400,15500,2),
 (18,'Puma','Future','42',6900,11000,2),
 (19,'Asics','Gel-Nimbus','43.5',6100,10000,3),
 (20,'Nike','VaporMax','42',12000,20500,3),
 (21,'Adidas','Gazelle','41',3400,7800,3),
 (22,'Puma','King','43',3700,7200,3),
 (23,'New Balance','574','42',7600,12800,3),
 (24,'Jordan','4 Low','44',16000,21800,3),
 (25,'Nike','Cortez','41.5',3900,8800,3),
 (26,'Adidas','Samba','42',4500,10200,3),
 (27,'Asics','Kayano','43',7200,10800,4),
 (28,'Nike','Pegasus','42',5400,9200,4),
 (29,'Puma','Roma','41',3100,7200,4),
 (30,'New Balance','Fresh Foam','44.5',5900,12800,4),
 (31,'Jordan','11 Low','42',12100,19800,4);
DROP VIEW IF EXISTS "batch_totals";
CREATE VIEW batch_totals AS
SELECT b.id, b.batch_name, b.purchase_date, COALESCE(SUM(p.cost), 0) as total_cost
FROM batches b LEFT JOIN products p ON b.id = p.batch_id 
GROUP BY b.id, b.batch_name, b.purchase_date ORDER BY b.purchase_date;
COMMIT;
